<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åç«¯ç›´æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .info { border-color: #17a2b8; background: #d1ecf1; }
        button {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 6px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        .result {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” åç«¯æœåŠ¡ç›´æ¥æµ‹è¯•</h1>
        
        <div class="test-section info">
            <h2>ğŸ“¡ æœåŠ¡çŠ¶æ€æ£€æŸ¥</h2>
            <button onclick="checkBackend()">æ£€æŸ¥åç«¯æœåŠ¡</button>
            <div id="statusResult" class="result">ç‚¹å‡»æŒ‰é’®æ£€æŸ¥åç«¯çŠ¶æ€...</div>
        </div>

        <div class="test-section">
            <h2>ğŸ” ç™»å½•åŠŸèƒ½æµ‹è¯•</h2>
            <div class="login-form">
                <input type="email" id="email" placeholder="é‚®ç®±" value="super@admin.com">
                <input type="password" id="password" placeholder="å¯†ç " value="admin123">
                <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            </div>
            <div id="loginResult" class="result">å¡«å†™ä¿¡æ¯åç‚¹å‡»æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ ä¸€é”®å®Œæ•´æµ‹è¯•</h2>
            <button onclick="runAllTests()" style="background: #28a745;">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <div id="allTestsResult" class="result">ç‚¹å‡»è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...</div>
        </div>
    </div>

    <script>
        const backendUrl = 'http://localhost:3001';
        
        function updateResult(elementId, content, className = '') {
            const element = document.getElementById(elementId);
            element.textContent = content;
            const section = element.closest('.test-section');
            section.className = 'test-section ' + className;
        }

        async function checkBackend() {
            updateResult('statusResult', 'æ­£åœ¨æ£€æŸ¥åç«¯æœåŠ¡...');
            
            try {
                // æ£€æŸ¥å¥åº·çŠ¶æ€
                const healthResponse = await fetch(`${backendUrl}/health`);
                
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    const result = `âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œï¼

æœåŠ¡çŠ¶æ€: ${healthData.status}
å“åº”æ—¶é—´: ${new Date().toISOString()}
æ•°æ®åº“çŠ¶æ€: ${healthData.services.database}
APIçŠ¶æ€: ${healthData.services.api}

å®Œæ•´å“åº”:
${JSON.stringify(healthData, null, 2)}`;
                    
                    updateResult('statusResult', result, 'success');
                } else {
                    updateResult('statusResult', `âŒ åç«¯æœåŠ¡å“åº”å¼‚å¸¸: HTTP ${healthResponse.status}`, 'error');
                }
            } catch (error) {
                updateResult('statusResult', `âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡: ${error.message}

è¯·ç¡®ä¿ï¼š
1. åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ (node simple-backend.js)
2. æœåŠ¡ç›‘å¬åœ¨ http://localhost:3001
3. é˜²ç«å¢™æ²¡æœ‰é˜»å¡3001ç«¯å£`, 'error');
            }
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            updateResult('loginResult', 'æ­£åœ¨æµ‹è¯•ç™»å½•åŠŸèƒ½...');
            
            try {
                const loginResponse = await fetch(`${backendUrl}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const loginData = await loginResponse.json();
                
                if (loginResponse.ok && loginData.success) {
                    const result = `âœ… ç™»å½•æµ‹è¯•æˆåŠŸï¼

ç”¨æˆ·ä¿¡æ¯:
- å§“å: ${loginData.data.user.fullName}
- è§’è‰²: ${loginData.data.user.role}
- é‚®ç®±: ${loginData.data.user.email}
- ç”¨æˆ·ID: ${loginData.data.user.id}

Token: ${loginData.data.token.substring(0, 30)}...

å®Œæ•´å“åº”:
${JSON.stringify(loginData, null, 2)}`;
                    
                    updateResult('loginResult', result, 'success');
                    
                    // æµ‹è¯•è®¤è¯çŠ¶æ€
                    setTimeout(() => testAuthStatus(loginData.data.token), 1000);
                    
                } else {
                    updateResult('loginResult', `âŒ ç™»å½•å¤±è´¥: ${loginData.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
                
            } catch (error) {
                updateResult('loginResult', `âŒ ç™»å½•è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testAuthStatus(token) {
            try {
                const meResponse = await fetch(`${backendUrl}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (meResponse.ok) {
                    const meData = await meResponse.json();
                    const current = document.getElementById('loginResult').textContent;
                    updateResult('loginResult', current + `

ğŸ”’ è®¤è¯çŠ¶æ€æµ‹è¯•: âœ… æˆåŠŸ
è®¤è¯ç”¨æˆ·: ${meData.data.user.fullName}`, 'success');
                }
            } catch (error) {
                const current = document.getElementById('loginResult').textContent;
                updateResult('loginResult', current + `

ğŸ”’ è®¤è¯çŠ¶æ€æµ‹è¯•: âŒ å¤±è´¥ (${error.message})`, 'success');
            }
        }

        async function runAllTests() {
            updateResult('allTestsResult', 'ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...\n\n');
            
            // æµ‹è¯•1: åç«¯å¥åº·æ£€æŸ¥
            updateResult('allTestsResult', 'ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...\n\n1. æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€...');
            
            try {
                const healthResponse = await fetch(`${backendUrl}/health`);
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    updateResult('allTestsResult', `ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...\n\n1. âœ… åç«¯æœåŠ¡çŠ¶æ€: ${healthData.status}\n\n2. æµ‹è¯•ç™»å½•åŠŸèƒ½...`);
                    
                    // æµ‹è¯•2: ç™»å½•åŠŸèƒ½
                    const loginResponse = await fetch(`${backendUrl}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            email: 'super@admin.com', 
                            password: 'admin123' 
                        })
                    });
                    
                    const loginData = await loginResponse.json();
                    
                    if (loginResponse.ok && loginData.success) {
                        updateResult('allTestsResult', `ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...\n\n1. âœ… åç«¯æœåŠ¡çŠ¶æ€: ${healthData.status}\n2. âœ… ç™»å½•åŠŸèƒ½æ­£å¸¸: ${loginData.data.user.fullName}\n\n3. æµ‹è¯•è®¤è¯çŠ¶æ€...`);
                        
                        // æµ‹è¯•3: è®¤è¯çŠ¶æ€
                        const meResponse = await fetch(`${backendUrl}/api/auth/me`, {
                            headers: { 
                                'Authorization': `Bearer ${loginData.data.token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (meResponse.ok) {
                            updateResult('allTestsResult', `ğŸš€ å®Œæ•´æµ‹è¯•æµç¨‹ç»“æœ:

1. âœ… åç«¯æœåŠ¡çŠ¶æ€: ${healthData.status}
2. âœ… ç™»å½•åŠŸèƒ½æ­£å¸¸: ${loginData.data.user.fullName}  
3. âœ… è®¤è¯çŠ¶æ€æ­£å¸¸: TokenéªŒè¯æˆåŠŸ

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼åç«¯æœåŠ¡å®Œå…¨æ­£å¸¸ï¼

ç°åœ¨æ‚¨å¯ä»¥ï¼š
1. è®¿é—®å‰ç«¯: http://localhost:3000/login
2. ä½¿ç”¨è´¦å·: super@admin.com / admin123
3. å¦‚æœå‰ç«¯è¿˜æ²¡å¯åŠ¨ï¼Œç­‰å¾…å‡ ç§’é’Ÿ`, 'success');
                        } else {
                            updateResult('allTestsResult', `æµ‹è¯•è¿‡ç¨‹ä¸­è®¤è¯çŠ¶æ€æ£€æŸ¥å¤±è´¥`, 'error');
                        }
                    } else {
                        updateResult('allTestsResult', `æµ‹è¯•è¿‡ç¨‹ä¸­ç™»å½•åŠŸèƒ½å¤±è´¥: ${loginData.error}`, 'error');
                    }
                } else {
                    updateResult('allTestsResult', `æµ‹è¯•è¿‡ç¨‹ä¸­åç«¯å¥åº·æ£€æŸ¥å¤±è´¥`, 'error');
                }
            } catch (error) {
                updateResult('allTestsResult', `å®Œæ•´æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.onload = function() {
            setTimeout(runAllTests, 500);
        };
    </script>
</body>
</html>
